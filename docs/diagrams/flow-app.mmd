%% Application Logic Flow v3.0 â€” Kyverno admission + CNPG Pooler detail
%% Owner: @ai-lead @platform-owner
%% Last Validated: 2026-02-23
%% Shows: Kyverno verifyImages at pod startup, full task execution,
%%         CNPG Pooler as explicit hop before Postgres.
%% Validation:
%%   kubectl get policyreport -A
%%   cosign verify --certificate-identity <ref> ghcr.io/helix-platform/langgraph:latest

sequenceDiagram
  autonumber

  participant K  as ðŸ›‚ Kyverno Admission
  participant W  as ðŸª Webhook Receiver
  participant Q  as ðŸ“¨ NATS Queue
  participant LG as ðŸ§  LangGraph
  participant OL as ðŸ¤– Ollama LLM
  participant ST as ðŸ•·ï¸ Steel Browser
  participant PB as ðŸ˜ CNPG Pooler
  participant DB as ðŸ—„ï¸ Postgres HA

  rect rgb(5, 46, 22)
    Note over K,DB: ðŸ›‚ Pod Startup â€” Kyverno verifyImages (keyless Cosign)
    K ->> W  : verify ghcr.io/helix-platform/webhook â€” mutateDigestâ†’SHA256
    K ->> LG : verify ghcr.io/helix-platform/langgraph â€” mutateDigestâ†’SHA256
    K ->> OL : verify ghcr.io/helix-platform/ollama â€” mutateDigestâ†’SHA256
    Note right of K: Unsigned images â†’ rejected\nDigest pinned â†’ tag-shift prevented
  end

  rect rgb(15, 23, 42)
    Note over W,Q: ðŸ“¨ Ingest Phase
    W  ->> Q  : enqueue(payload, idempotency_key)
    Q -->> W  : ack
  end

  rect rgb(30, 27, 75)
    Note over LG,OL: ðŸ§  Inference Phase
    Q  ->> LG : process_task(job_id)
    LG ->> OL : prompt(context, instructions)
    OL -->> LG: completion(tokens)
  end

  rect rgb(12, 74, 110)
    Note over LG,ST: ðŸ•·ï¸ Scrape Phase (conditional)
    LG ->> ST : scrape(url, selector)
    ST -->> LG: page_content(html, metadata)
  end

  rect rgb(59, 7, 100)
    Note over LG,DB: ðŸ’¾ Persist Phase â€” via CNPG Pooler
    LG ->> PB : INSERT results (transaction pool)
    PB ->> DB : pooled backend connection
    DB -->> PB: rows_inserted
    PB -->> LG: ack
    Note right of PB: max 1000 frontend connections\n20 backend Postgres connections\nOOM prevention
  end

  rect rgb(5, 46, 22)
    Note over Q,W: âœ… Completion
    LG ->> Q  : ack(job_id, status=done)
    Q -->> W  : notify done
  end
