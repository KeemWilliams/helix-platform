# Helix Platform: Devtron Custom Values
# Owner: @platform-owner @db-owner @security-lead
#
# CRITICAL: argo-cd.enabled MUST be false if an external enterprise ArgoCD is present.
# Two ArgoCD controllers managing the same cluster = fatal CRD contention and split-brain.
# See docs/DEVTRON_ANALYSIS.md for full architectural rationale.

installer:
  modules:
    - cicd

# ------------------------------------------------------------------------------
# ArgoCD Management
# ------------------------------------------------------------------------------
# DECISION: Hard-disabled. We operate an external enterprise ArgoCD instance.
# Enabling this alongside external ArgoCD causes fatal CRD contention, race conditions,
# and split-brain reconciliation loops (Assessment Verdict: FAIL 40/100 if enabled).
argo-cd:
  enabled: false

# Prevent Devtron from installing/overwriting CRDs managed by the external ArgoCD.
crds:
  install: false

# ------------------------------------------------------------------------------
# Database Configurations (CloudNativePG HA Integration)
# ------------------------------------------------------------------------------
externalPostgres:
  enabled: true
  # Devtron requires these four logical databases to be pre-created manually:
  #   CREATE DATABASE orchestrator;
  #   CREATE DATABASE lens;
  #   CREATE DATABASE git_sensor;
  #   CREATE DATABASE casbin;
  PG_ADDR: "platform-db-cluster-rw.platform.svc.cluster.local"
  PG_PORT: "5432"
  PG_DATABASE: "orchestrator"
  PG_USER: "devtron_user"
  # SOPS PLACEHOLDER: inject via CI/CD or use External Secrets Operator
  PG_PASSWORD: "<SOPS_ENCRYPTED_DB_PASSWORD>"

dbConfig:
  PG_USER: "devtron_user"
  PG_DATABASE: "orchestrator"

# ------------------------------------------------------------------------------
# Redis Cache (External — ElastiCache or in-cluster HA Redis)
# ------------------------------------------------------------------------------
redis:
  enabled: false
  external:
    enabled: true
    existingSecretName: "platform-redis-secret"
    connectionUrlSecretKey: "REDIS_URI_CUSTOM"

# ------------------------------------------------------------------------------
# NATS Messaging Pipeline (External)
# ------------------------------------------------------------------------------
nats:
  enabled: false

# Override the ConfigMap that NATS streaming reads for connection config
nats-streaming-override-cm:
  auth:
    secretName: "platform-nats-secret"
  natsSvc: "nats://platform-nats.platform.svc.cluster.local:4222"

# ------------------------------------------------------------------------------
# Ingress and TLS (Traefik v3 — IngressRoute CRD approach)
# ------------------------------------------------------------------------------
# NOTE: Traefik chart v28+ defaults to Traefik Proxy v3 using IngressRoute CRDs.
# See docs/TRAEFIK_ANALYSIS.md. We use cross-namespace middleware via @kubernetescrd.
ingress:
  enabled: true
  className: "traefik"
  allowPublic: false
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # Cross-namespace ForwardAuth middleware — requires Traefik --providers.kubernetescrd.allowCrossNamespace=true
    traefik.ingress.kubernetes.io/router.middlewares: "authentik-forwardauth@kubernetescrd"
  hosts:
    - host: devtron.example.com
      paths:
        - path: /
          pathType: ImplementationSpecific

# ------------------------------------------------------------------------------
# SSO / OIDC Authentication (via Authentik)
# ------------------------------------------------------------------------------
auth:
  oidc:
    enabled: true
    issuer: "https://auth.example.com/"
    # SOPS PLACEHOLDER:
    clientId: "<SOPS_ENCRYPTED_CLIENT_ID>"
    clientSecret: "<SOPS_ENCRYPTED_CLIENT_SECRET>"
    redirectUris:
      - "https://devtron.example.com/api/dex/callback"

# ------------------------------------------------------------------------------
# CI/CD Mode: Observability Only
# ------------------------------------------------------------------------------
# GitHub Actions handles all builds and Cosign signing.
# Devtron is used for GitOps CD visualization and observability only.
pipelines:
  enabled: false
