name: Build Sign and Publish

on:
  push:
    branches:
      - main
      - release/*

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/yourorg/${{ github.repository }}:${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU and Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Install cosign
        run: |
          COSIGN_VERSION="2.1.0"
          curl -sSL -o cosign.tar.gz "https://github.com/sigstore/cosign/releases/download/v${COSIGN_VERSION}/cosign-linux-amd64.tar.gz"
          tar -xzf cosign.tar.gz cosign
          sudo mv cosign /usr/local/bin/cosign

      - name: Sign image with cosign
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_PASSWORD" | cosign generate-key-pair
          # In CI you should use a KMS-backed key; this example uses ephemeral keypair for demo
          cosign sign --key cosign.key "$IMAGE"
          # Upload signature to registry (cosign does this automatically for OCI registries)

      - name: Upload image metadata
        uses: actions/upload-artifact@v4
        with:
          name: image-info
          path: |
            cosign.pub
            cosign.key
