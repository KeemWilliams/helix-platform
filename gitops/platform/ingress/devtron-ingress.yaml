apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: protected-devtron-dashboard
  namespace: devtroncd
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # Cross-namespace middleware reference format: <namespace>-<middleware-name>@kubernetescrd
    # REQUIRES Traefik startup flag: --providers.kubernetescrd.allowCrossNamespace=true
    # Without this flag, Traefik SILENTLY ignores the middleware (no error, no auth enforcement!)
    traefik.ingress.kubernetes.io/router.middlewares: "authentik-forwardauth@kubernetescrd"
spec:
  ingressClassName: traefik
  rules:
    - host: devtron.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: devtron-service
                port:
                  number: 80
  tls:
    - hosts:
        - devtron.example.com
      secretName: devtron-tls-cert
---
# The Authentik ForwardAuth Middleware
# Deploy this in the 'authentik' namespace; reference it cross-namespace via @kubernetescrd
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: forwardauth
  namespace: authentik
spec:
  forwardAuth:
    address: "http://authentik-outpost.authentik.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik"
    trustForwardHeader: true
    authResponseHeaders:
      - X-authentik-username
      - X-authentik-groups
      - X-authentik-email
      - X-authentik-uid
