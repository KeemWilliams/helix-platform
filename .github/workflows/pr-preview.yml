name: PR Preview Environment
on: [pull_request]
jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and push image
        run: |
          IMAGE=ghcr.io/yourorg/${{ github.repository }}:${{ github.sha }}
          docker build -t $IMAGE .
          echo "${{ secrets.REGISTRY_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push $IMAGE
      - name: Deploy preview
        run: |
          # Requires kustomize configuration overlays/pr to exist
          kustomize build overlays/pr | kubectl apply -f - -n pr-${{ github.event.number }}
      - name: Post preview URL
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.number }}
          body: "Preview Environment Successfully Deployed: https://pr-${{ github.event.number }}.staging.example.com"
