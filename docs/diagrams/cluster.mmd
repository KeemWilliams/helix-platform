%% Cluster Architecture v3.2 â€” Elite Version
%% Physical Node & Resource Mapping
%% Owner: @infra-owner
%% Last Validated: 2026-02-23

graph TD
  classDef pool  fill:#1c1917,stroke:#f97316,stroke-width:2px,color:#fed7aa;
  classDef svc   fill:#1e1b4b,stroke:#818cf8,stroke-width:1.5px,color:#c7d2fe;
  classDef store fill:#3b0764,stroke:#c084fc,stroke-width:2px,color:#f3e8ff;
  classDef sec   fill:#052e16,stroke:#4ade80,stroke-width:2px,color:#bbf7d0;

  %% â”€â”€ NODE POOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  subgraph CP ["âš™ï¸ Control Plane Pool (3 Nodes)"]
    CP1["cp-01"]:::pool
    CP2["cp-02"]:::pool
    CP3["cp-03"]:::pool
  end

  subgraph WS ["ðŸ’» General Workload Pool"]
    W1["worker-01"]:::pool
    W2["worker-02"]:::pool
  end

  subgraph WH ["ðŸ§  High-Compute / Inference Pool"]
    WH1["worker-high-01\nGPU-capable"]:::pool
    WH2["worker-high-02\nGPU-capable"]:::pool
  end

  subgraph DB ["ðŸ’¾ Database Pool (gp3 NVMe)"]
    direction LR
    DB1["db-01"]:::pool
    DB2["db-02"]:::pool
    DB3["db-03"]:::pool
  end

  %% â”€â”€ SERVICES & STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  subgraph CONN ["ðŸ”Œ Connection Pooling Layer"]
    Pooler(["CNPG Pooler\nPgBouncer transaction mode\nmax_client_conn 1000"]):::svc
  end

  subgraph STORAGE ["ðŸ’¾ Stateful Storage Tier"]
    ETCD[("etcd\n3x raft replicas")]:::store
    LH[("Longhorn HA\ngp3 StorageClass")]:::store
    CNPG[("CloudNativePG\n3 replicas synchronous\nBarman WAL to S3")]:::store
  end

  subgraph NET ["ðŸ›‚ Network and Policy Layer"]
    Cilium{"Cilium CNI\neBPF L3/L4/L7"}:::sec
    Kyverno{"Kyverno\nverifyImages admission"}:::sec
  end

  %% â”€â”€ RELATIONSHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CP  --- ETCD
  WS  --- LH
  WH  --- LH
  DB  --- CNPG

  WS  -->|"app db connections"| Pooler
  WH  -->|"app db connections"| Pooler
  Pooler -->|"pooled connections"| CNPG

  Cilium  -.->|"default-deny"| WS
  Cilium  -.->|"default-deny"| WH
  Cilium  -.->|"default-deny"| DB
  Kyverno -.->|"image admission"| WS
  Kyverno -.->|"image admission"| WH

  %% â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  subgraph LEGEND ["ðŸ“Š Legend"]
    direction LR
    L1["Physical Node"]:::pool
    L2(["Service / Logic"]):::svc
    L3[("Storage / DB")]:::store
    L4{"Policy / Security"}:::sec
  end
