apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: argocd-telemetry-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: argocd.sync.rules
      rules:
        - alert: ArgoAppSyncFailed
          expr: argocd_app_sync_total{phase!="Succeeded"} == 1
          for: 1m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "GitOps Application Sync Failure: {{ $labels.name }}"
            description: >
              ArgoCD Application {{ $labels.name }} has registered a failed sync
              phase ({{ $labels.phase }}). Inspect the application controller logs
              immediately to determine if admission control (Kyverno) or resource
              exhaustion prevented the rollout.
            runbook_url: "https://github.com/helix-platform/helix-platform/blob/main/docs/runbook.md"

        - alert: ArgoAppConfigurationDrift
          expr: argocd_app_info{sync_status="OutOfSync"} == 1
          for: 15m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Configuration Drift Detected: {{ $labels.name }}"
            description: >
              ArgoCD Application {{ $labels.name }} has been out of sync for
              over 15 minutes, indicating manual cluster intervention or a failed 
              automated rollback. Review the ArgoCD timeline immediately.
            runbook_url: "https://github.com/helix-platform/helix-platform/blob/main/docs/runbook.md"

        - alert: ArgoAppHealthDegraded
          expr: argocd_app_info{health_status!="Healthy"} == 1
          for: 5m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "ArgoCD Application Unhealthy: {{ $labels.name }}"
            description: >
              ArgoCD Application {{ $labels.name }} health status is {{ $labels.health_status }}.
              This may indicate crashing pods, failing health checks, or a blocked rollout.
            runbook_url: "https://github.com/helix-platform/helix-platform/blob/main/docs/runbook.md"
