name: Mermaid Visual Diff
on:
  pull_request:
    paths:
      - 'docs/diagrams/**.mmd'

jobs:
  visual-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mermaid-cli
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Render diagrams
        run: |
          mkdir -p new-diagrams
          for f in docs/diagrams/*.mmd; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .mmd)
            mmdc -i "$f" -o "new-diagrams/${base}.svg"
          done

      - name: Post Visual Diff Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            **Visual Diff Preview**
            The SVG outputs for the changed architecture diagrams have been regenerated. 
            Reviewers can download the `mermaid-svgs` artifact from the Actions tab or pull the `docs/diagrams/*.svg` updates locally to compare visual topology alterations before merging!
