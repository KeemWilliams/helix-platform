name: Check Links and MAP.md

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'gitops/platform/**/*.md'
      - 'README.md'

jobs:
  link-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Run Markdown Link Check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/mlc_config.json'
          folder-path: 'docs, gitops/platform'
          # Ignore relative links outside the repo root
          max-depth: 3

  map-update-enforcer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if Mermaid diagrams changed
        id: diagrams-changed
        run: |
          git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E "\.mmd$" || true
          if git diff --name-only origin/${{ github.base_ref }} HEAD | grep -q -E "\.mmd$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Enforce MAP.md update
        if: steps.diagrams-changed.outputs.changed == 'true'
        run: |
          if ! git diff --name-only origin/${{ github.base_ref }} HEAD | grep -q "docs/diagrams/MAP.md"; then
            echo "::error::Architecture diagrams (*.mmd) were changed, but docs/diagrams/MAP.md was not updated. Please update the MAP.md file to reflect your node or owner changes."
            exit 1
          fi
          echo "MAP.md was included with the architecture changes. Proceeding."
