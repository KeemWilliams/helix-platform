%% Webhook Flow v3.1 â€” Fixed shapes, quoted labels
%% Owner: platform-team@example.com
%% Last validated: 2026-02-23
%%{init:{"theme":"base","themeVariables":{"primaryColor":"#0f172a","primaryTextColor":"#f1f5f9","primaryBorderColor":"#6366f1","lineColor":"#64748b","secondaryColor":"#1e293b","background":"#020617","mainBkg":"#1e293b","clusterBkg":"#0f172a","clusterBorder":"#334155","titleColor":"#f8fafc","edgeLabelBackground":"#0f172a","fontFamily":"Inter, system-ui, sans-serif","fontSize":"13px"}}}%%

flowchart LR
  classDef ext   fill:#1e293b,stroke:#94a3b8,stroke-width:1.5px,color:#cbd5e1,font-style:italic;
  classDef infra fill:#0c4a6e,stroke:#0ea5e9,stroke-width:2px,color:#e0f2fe;
  classDef sec   fill:#052e16,stroke:#4ade80,stroke-width:2px,color:#bbf7d0;
  classDef apps  fill:#1e1b4b,stroke:#818cf8,stroke-width:1.5px,color:#c7d2fe;
  classDef db    fill:#3b0764,stroke:#c084fc,stroke-width:2px,color:#f3e8ff;
  classDef obs   fill:#1c1917,stroke:#fb923c,stroke-width:1.5px,color:#fed7aa;

  subgraph EXT ["External"]
    direction TB
    User(("User")):::ext
    PartnerAPI(("Partner API")):::ext
  end

  subgraph EDGE ["Edge / Cloud"]
    LB(["Hetzner LB"]):::infra
    EgressProxy(["Envoy Egress Proxy"]):::infra
    NAT(["NAT / Stable Egress IPs"]):::infra
  end

  subgraph AUTH ["Auth Gate"]
    Traefik(["Traefik Ingress v3"]):::infra
    Authentik{"Authentik OIDC\nForwardAuth outpost"}:::sec
  end

  subgraph CLUSTER ["Talos Cluster"]
    Webhook("Webhook Receiver\nHMAC validated"):::apps
    Queue[("NATS Queue\nidempotent events")]:::db
    n8n("n8n Orchestrator"):::apps
    LangGraph("LangGraph"):::apps
    Ollama("Ollama LLM"):::apps
    CNPGPooler(["CNPG Pooler\nPgBouncer"]):::db
    Postgres[("Postgres HA")]:::db
    Redis[("Redis Cache")]:::db
    Steel("Steel Browser\negress only"):::apps
    Callback("Callback Worker"):::apps
  end

  subgraph OPS ["Ops and GitOps"]
    Prometheus("Prometheus"):::obs
    AlertManager("Alertmanager"):::obs
    Remediate("Remediation"):::obs
    ArgoCD("ArgoCD\nexternal controller"):::apps
  end

  User -->|"HTTPS"| LB --> Traefik
  Traefik ==>|"ForwardAuth check"| Authentik
  Authentik -.->|"302 if unauthenticated"| User
  Authentik -.->|"authed"| Webhook

  Webhook -.->|"async enqueue\nidempotent key"| Queue
  Queue   -->|"job"| n8n
  n8n     -->|"invoke"| LangGraph
  LangGraph -->|"prompt"| Ollama
  Ollama  ---->|"completion"| LangGraph
  LangGraph -->|"cache"| Redis
  LangGraph -->|"write"| CNPGPooler --> Postgres
  n8n     -.->|"publish done"| Queue
  Queue   -->|"callback job"| Callback
  Callback -->|"HTTP callback"| User

  Steel -->|"egress via"| EgressProxy --> NAT
  Steel -.->|"parsed data"| Queue
  n8n   -->|"external API"| EgressProxy
  Callback -->|"external callback"| EgressProxy
  NAT   -->|"stable IP"| PartnerAPI

  Queue        -->|"metrics"| Prometheus
  Prometheus   -->|"alert"| AlertManager
  AlertManager -->|"trigger"| Remediate
  Remediate    -.->|"rollback PR"| ArgoCD
