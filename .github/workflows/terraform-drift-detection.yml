name: "Terraform Drift Detection"
on:
  schedule:
    - cron: "0 6 * * *" # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  id-token: write # Required for AWS OIDC federation
  contents: read
  issues: write

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: infra/envs/prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC â€” no static keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.TF_ASSUME_ROLE_ARN }}
          aws-region: us-east-1
          role-duration-seconds: 900

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.0 # 1.10+ required for S3 native locking

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=helix-terraform-state-bucket" \
            -backend-config="key=prod.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="use_lockfile=true"

      - name: Terraform Plan (detailed-exitcode)
        id: tf-plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: bash
        run: |
          export exitcode=0
          # exit code: 0=no changes, 1=error, 2=drift/pending changes
          terraform plan -detailed-exitcode -no-color -out=tfplan.binary | tee plan.txt || export exitcode=$?
          terraform show -no-color tfplan.binary > tfplan.txt || true
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/plan.txt
            ${{ env.TF_WORKING_DIR }}/tfplan.txt

      - name: Open GitHub Issue on Drift (exit code 2)
        if: steps.tf-plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.TF_WORKING_DIR }}/tfplan.txt', 'utf8').slice(0, 60000);
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CRITICAL: Terraform Drift Detected in infra/envs/prod',
              labels: ['drift', 'infra', 'automated'],
              assignees: ['infra-owner'],
              body: [
                '## Terraform Configuration Drift Detected',
                '',
                'Automated daily drift detection identified a divergence between the **Git source of truth** and the **live cloud infrastructure**.',
                '',
                '**Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                '',
                '### Remediation Options',
                '1. **Accept the drift**: Update Terraform code to match reality, open PR, merge.',
                '2. **Revert the drift**: Run `terraform apply` to reset the cloud state back to Git.',
                '',
                '### Plan Output',
                '```hcl',
                plan,
                '```',
                '',
                '> cc: @infra-owner @sre-lead'
              ].join('\n')
            });

      - name: Fail job on Terraform error (exit code 1)
        if: steps.tf-plan.outputs.exitcode == '1'
        run: |
          echo "::error::Terraform plan encountered an error (exit code 1). Check the plan output artifact."
          exit 1
