name: Verify DR Restore (Staging)

on:
  schedule:
    - cron: '0 2 * * 0' # Run every Sunday at 2 AM
  workflow_dispatch:

jobs:
  verify-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Authenticate to staging cluster
        env:
          KUBECONFIG_DATA: ${{ secrets.STAGING_KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config

      - name: Apply recovery manifest
        run: |
          # The recovery manifest defines a standard CNPG point-in-time restore
          kubectl apply -f scripts/dr-test/recovery-cluster.yaml

      - name: Wait for Postgres recovery
        run: |
          kubectl -n platform wait --for=condition=Ready cluster/postgres-recovery --timeout=600s

      - name: Run verification script
        run: |
          # Connect to the restored database and run a simple count test
          kubectl -n platform exec -it cluster/postgres-recovery-1 -- psql -c "SELECT count(*) FROM state;"

      - name: Clean up secondary cluster
        if: always()
        run: |
          kubectl delete -f scripts/dr-test/recovery-cluster.yaml
