%% Bootstrap Sequence v3.0 â€” Rich detail with emojis
%% Owner: @infra-owner @ci-owner
%% Last Validated: 2026-02-23
%% End-to-end cluster bootstrap sequence showing all platform primitives,
%% S3 native lock lifecycle, NetBird ephemeral join, and SOPS late-stage decrypt.
%% Validation:
%%   terraform init -backend-config=infra/envs/prod/backend.tf
%%   terraform plan -detailed-exitcode
%%   netbird status  (inside CI runner)
%%   kubectl get pods -n devtroncd | grep argocd  # expected: empty

sequenceDiagram
  autonumber

  participant TF    as ðŸ—ï¸ Terraform
  participant S3    as ðŸ—„ï¸ S3 State Bucket
  participant KMS   as ðŸ” KMS
  participant Hetz  as ðŸ–¥ï¸ Hetzner API
  participant Talos as âš™ï¸ Talos Linux
  participant K8s   as âŽˆ Kubernetes API
  participant NB    as ðŸ•¸ï¸ NetBird Mesh
  participant CI    as ðŸ¤– CI Runner
  participant SOPS  as ðŸ”‘ SOPS / KMS
  participant Helm  as ðŸ“¦ Helm
  participant ArgoCD as ðŸ”„ ArgoCD

  rect rgb(15, 23, 42)
    Note over TF,S3: â˜ï¸ Phase 1 â€” Terraform Bootstrap
    TF  ->> S3   : init backend (use_lockfile=true, no DynamoDB)
    S3  -->> TF  : âœ… backend ready
    TF  ->> KMS  : verify kms:Decrypt access for state SSE
    KMS -->> TF  : âœ… key accessible
    TF  ->> S3   : PutObject terraform.tfstate.tflock â€” acquire lock
    S3  -->> TF  : âœ… lock granted
    TF  ->> Hetz : provision VMs, networks, floating IPs
    Hetz -->> TF : âœ… resources created
    TF  ->> S3   : DeleteObject *.tflock â€” release lock
    S3  -->> TF  : âœ… lock released
    TF  ->> CI   : write outputs.json (egress IPs, kubeconfig path)
  end

  rect rgb(5, 46, 22)
    Note over CI,NB: ðŸ•¸ï¸ Phase 2 â€” NetBird Mesh & Secure Access
    CI  ->> NB   : netbird up --setup-key $EPHEMERAL_KEY
    NB  -->> CI  : âœ… peer registered (ephemeral â€” auto-deregisters in 10m)
    Note right of NB: No public K8s API exposure.\nAll admin access goes through NetBird.
  end

  rect rgb(12, 74, 110)
    Note over CI,K8s: âŽˆ Phase 3 â€” Cluster Bootstrap
    CI  ->> Talos: apply controlplane.yaml
    Talos -->> K8s: bootstrap etcd + API server
    K8s  -->> CI  : âœ… API ready
    CI  ->> K8s  : install Cilium CNI
    CI  ->> K8s  : install cert-manager + ClusterIssuer
    CI  ->> K8s  : install Traefik (IngressRoute CRDs enabled)
    CI  ->> K8s  : install Kyverno (Audit mode first)
    CI  ->> K8s  : install ArgoCD external controller
  end

  rect rgb(59, 7, 100)
    Note over CI,Helm: ðŸ” Phase 4 â€” SOPS Decrypt + Platform Install
    CI   ->> SOPS : sops --decrypt secrets.enc.yaml (KMS via OIDC role)
    SOPS -->> CI  : âœ… secrets.yaml (plaintext â€” ephemeral)
    CI   ->> Helm : helm upgrade devtron\n  --set argo-cd.enabled=false\n  -f values.devtron.custom.yaml\n  -f secrets.yaml
    Helm -->> K8s : deploy Devtron pods (no ArgoCD pods expected)
    CI   ->> CI   : rm secrets.yaml  # ðŸ”¥ delete immediately
    Note right of CI: SOPS plaintext never persists\nbeyond helm upgrade call.
  end

  rect rgb(63, 7, 20)
    Note over ArgoCD,K8s: ðŸ”„ Phase 5 â€” GitOps Handover
    ArgoCD ->> K8s  : apply gitops/platform/** (all CRDs, apps)
    K8s    -->> ArgoCD: âœ… resources reconciled
    ArgoCD ->> K8s  : Kyverno validationFailureAction â†’ Enforce
    Note right of ArgoCD: After all production images\nare Cosign-signed.
  end
