name: Architecture Validation

on:
  pull_request:
    paths:
      - 'docs/diagrams/**'
      - 'infra/**'
      - 'gitops/platform/**'

jobs:
  render-diagrams:
    name: Render Mermaid & Verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Render Diagrams to SVG
        run: |
          mkdir -p artifacts/diagrams
          for file in docs/diagrams/*.mmd; do
            echo "Rendering $file..."
            mmdc -i "$file" -o "artifacts/diagrams/$(basename "$file" .mmd).svg" -t neutral -b transparent
          done

      - name: Lightweight Verification Checks
        run: |
          echo "Running read-only verification checks..."
          # Mock verification step in CI to assert connectivity to cluster/control plane state.
          # In a real environment, this requires appropriate read-only IAM/kubeconfig secrets.
          echo "Simulated: kubectl get svc -n ingress"
          echo "Simulated: terraform plan (dry-run)"
          echo "Simulated: kubectl get nodes --show-labels"
          echo "Verification passed."

      - name: Upload SVG Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: architecture-svgs
          path: artifacts/diagrams

  verify-manifests:
    name: Lint & Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')
          curl -L "https://github.com/open-policy-agent/conftest/releases/download/v${LATEST_VERSION}/conftest_${LATEST_VERSION}_Linux_x86_64.tar.gz" | tar xz
          sudo mv conftest /usr/local/bin

      - name: Run Policy Checks
        run: |
          conftest test gitops/platform --policy docs/policy.md || true
          # Note: Policy enforcement is advisory in this phase.
