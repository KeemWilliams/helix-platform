# Helix Platform — Reusable SOPS Decrypt + Helm Deploy Workflow
# Owner: @ci-owner
#
# This reusable workflow (workflow_call) performs late-stage SOPS decryption
# immediately before Helm chart deployment. Decrypting early risks leaking
# secrets into workflow logs; decrypting here keeps the window as short as
# possible and ensures the plaintext file is deleted immediately after use.
#
# Assessment reference: Section D — CI, SBOM, cosign, Kyverno, SOPS (PASS)
#   "Decrypting SOPS secrets too early in CI risks leakage in workflow logs."
#   Safe Default: Decrypt at the last possible step, delete immediately after.
#
# Usage (caller workflow):
#   jobs:
#     deploy:
#       uses: ./.github/workflows/sops-decrypt-and-deploy.yml
#       with:
#         chart_path: gitops/platform/myapp
#         release_name: myapp
#         namespace: platform
#         encrypted_values_file: secrets/myapp.enc.yaml
#       secrets:
#         TF_ASSUME_ROLE_ARN: ${{ secrets.CI_SOPS_ROLE_ARN }}

name: "SOPS Decrypt and Helm Deploy"

on:
    workflow_call:
        inputs:
            chart_path:
                description: "Path to the Helm chart directory"
                required: true
                type: string
            release_name:
                description: "Helm release name"
                required: true
                type: string
            namespace:
                description: "Kubernetes namespace to deploy into"
                required: true
                type: string
            encrypted_values_file:
                description: "Path to the SOPS-encrypted values file (relative to repo root)"
                required: true
                type: string
            aws_region:
                description: "AWS region of the KMS key"
                required: false
                type: string
                default: "us-east-1"
        secrets:
            TF_ASSUME_ROLE_ARN:
                description: "IAM role ARN with kms:Decrypt access (assumed via OIDC)"
                required: true

permissions:
    id-token: write # Required for AWS OIDC federation
    contents: read

jobs:
    deploy:
        name: "Decrypt Secrets & Helm Deploy"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure AWS credentials (OIDC — no static keys)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.TF_ASSUME_ROLE_ARN }}
                  aws-region: ${{ inputs.aws_region }}
                  role-duration-seconds: 600 # Short-lived: 10 minutes

            - name: Install SOPS
              run: |
                  SOPS_VERSION="v3.9.4"
                  curl -fsSL "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" \
                    -o /usr/local/bin/sops
                  chmod +x /usr/local/bin/sops
                  sops --version

            - name: Install Helm
              uses: azure/setup-helm@v4

            - name: Configure kubectl (EKS/kubeconfig)
              # Assumes KUBECONFIG or aws eks update-kubeconfig was performed upstream
              run: aws eks update-kubeconfig --name helix-platform-prod --region ${{ inputs.aws_region }}

            # ── CRITICAL SECURITY PATTERN ─────────────────────────────────────────
            # Decrypt → Apply → Delete in consecutive atomic steps.
            # NEVER commit or upload the decrypted secrets.yaml to any artifact.
            - name: Decrypt SOPS secrets (late-stage)
              run: |
                  sops --decrypt "${{ inputs.encrypted_values_file }}" > secrets.yaml
                  echo "::notice::Secrets decrypted. Will be deleted immediately after helm install."

            - name: Helm upgrade/install with decrypted secrets
              run: |
                  helm upgrade --install "${{ inputs.release_name }}" "${{ inputs.chart_path }}" \
                    --namespace "${{ inputs.namespace }}" \
                    --create-namespace \
                    --atomic \
                    --timeout 5m \
                    -f secrets.yaml

            - name: Delete decrypted secrets (prevent log leakage)
              if: always() # Run even if helm fails — secrets must always be cleaned up
              run: |
                  rm -f secrets.yaml
                  echo "✅ secrets.yaml deleted."
